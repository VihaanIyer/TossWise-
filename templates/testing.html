<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Testing - TossWise</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: rgb(164, 194, 157); /* Sage Green */
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }
        
        .app-container {
            max-width: 900px;
            margin: 0 auto;
            background: rgb(243, 243, 233);
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 30px rgba(41, 50, 40, 0.2);
        }
        
        .app-header {
            background: rgb(164, 194, 157);
            padding: 40px 60px 30px 60px;
            padding-top: max(40px, env(safe-area-inset-top));
            border-bottom: 1px solid rgba(41, 50, 40, 0.1);
            position: relative;
        }
        
        .school-name {
            color: rgb(2, 3, 3);
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
        }
        
        .app-title {
            color: rgb(2, 3, 3);
            font-size: 36px;
            font-weight: 700;
        }
        
        .live-indicator {
            position: absolute;
            top: 40px;
            right: 60px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(220, 53, 69, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid #dc3545;
        }
        
        .live-dot {
            width: 10px;
            height: 10px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }
        
        .live-text {
            color: #dc3545;
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .app-content {
            padding: 40px 60px;
            padding-bottom: max(40px, env(safe-area-inset-bottom));
            text-align: center;
        }
        
        .status-card {
            background: white;
            border-radius: 20px;
            padding: 40px 32px;
            margin-bottom: 40px;
            border: 2px solid rgb(107, 125, 141);
            box-shadow: 0 4px 12px rgba(41, 50, 40, 0.1);
        }
        
        .status-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .status-text {
            color: rgb(41, 50, 40);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
        }
        
        .status-desc {
            color: rgb(107, 125, 141);
            font-size: 17px;
            line-height: 1.6;
        }
        
        .spinner-container {
            margin: 32px 0;
        }
        
        .spinner {
            border: 4px solid rgb(243, 243, 233);
            border-top: 4px solid rgb(41, 50, 40);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-card {
            background: rgb(243, 243, 233);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 32px;
            border: 2px solid rgb(107, 125, 141);
        }
        
        .info-text {
            color: rgb(107, 125, 141);
            font-size: 14px;
            line-height: 1.6;
        }
        
        .btn-primary {
            background: rgb(41, 50, 40);
            color: white;
            border: none;
            padding: 20px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            touch-action: manipulation;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(41, 50, 40, 0.4);
        }
        
        .btn-primary:active {
            transform: scale(0.96);
            background: rgb(2, 3, 3);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-stop {
            background: #dc3545;
            color: white;
            border: none;
            padding: 20px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            touch-action: manipulation;
        }
        
        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
            background: #c82333;
        }
        
        .btn-stop:active {
            transform: scale(0.96);
            background: #a71e2a;
        }
        
        .btn-stop:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Insights Section */
        .insights-section {
            margin-bottom: 40px;
            text-align: left;
        }
        
        .insights-title {
            color: rgb(2, 3, 3);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 24px;
        }
        
        .bins-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .bin-card {
            background: white;
            border-radius: 16px;
<<<<<<< HEAD
            padding: 24px;
            border: 2px solid rgb(107, 125, 141);
            box-shadow: 0 2px 8px rgba(41, 50, 40, 0.1);
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .bin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(41, 50, 40, 0.15);
=======
            padding: 20px;
            border: 2px solid rgb(107, 125, 141);
            box-shadow: 0 2px 8px rgba(41, 50, 40, 0.1);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
>>>>>>> 39f4406 (Updated UI to laptop layout, added trash falling animation, improved question handling, and fixed camera index)
        }
        
        .bin-label {
            color: rgb(41, 50, 40);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: capitalize;
        }
        
        .bin-visual {
            position: relative;
            width: 100px;
            height: 120px;
            margin: 0 auto 12px;
            background: #f0f0f0;
            border-radius: 8px;
            border: 3px solid rgb(107, 125, 141);
            overflow: hidden;
        }
        
        /* Trash falling animation container */
        .trash-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }
        
        .falling-trash {
            position: absolute;
            font-size: 24px;
            animation: fallIntoBin 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: none;
            z-index: 1001;
        }
        
        @keyframes fallIntoBin {
            0% {
                opacity: 1;
                transform: translateY(0) translateX(0) rotate(0deg) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(var(--fall-distance)) translateX(var(--offset-x)) rotate(180deg) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(var(--fall-distance)) translateX(var(--offset-x)) rotate(360deg) scale(0.3);
            }
        }
        
        /* Bin card animation when item is added */
        .bin-card.new-item {
            animation: binPulse 0.6s ease-out;
        }
        
        @keyframes binPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(41, 50, 40, 0.1);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 16px rgba(41, 50, 40, 0.3);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(41, 50, 40, 0.1);
            }
        }
        
        .bin-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, currentColor, currentColor);
            transition: height 0.5s ease-out;
            border-radius: 0 0 5px 5px;
        }
        
        .bin-fill.recycling { color: #2563eb; }
        .bin-fill.compost { color: #16a34a; }
        .bin-fill.landfill { color: #374151; }
        
        .bin-fill.new-item {
            animation: fillBounce 0.8s ease-out;
        }
        
        @keyframes fillBounce {
            0% {
                transform: scaleY(0.8);
            }
            50% {
                transform: scaleY(1.05);
            }
            100% {
                transform: scaleY(1);
            }
        }
        
        .bin-percentage {
            color: rgb(2, 3, 3);
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 6px;
        }
        
        .bin-count {
            color: rgb(107, 125, 141);
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .contamination-indicator {
            margin-top: 8px;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .contamination-indicator.clean {
            background: #d1fae5;
            color: #065f46;
        }
        
        .contamination-indicator.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .contamination-indicator.contaminated {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .stats-summary {
            background: rgb(243, 243, 233);
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
            border: 2px solid rgb(107, 125, 141);
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 16px;
        }
        
        .stat-label {
            color: rgb(107, 125, 141);
            font-size: 16px;
        }
        
        .stat-value {
            color: rgb(2, 3, 3);
            font-weight: 600;
            font-size: 18px;
        }
        
        /* Trash falling animation container */
        .trash-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }
        
        .falling-trash {
            position: absolute;
            font-size: 28px;
            animation: fallIntoBin 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: none;
            z-index: 1001;
        }
        
        @keyframes fallIntoBin {
            0% {
                opacity: 1;
                transform: translateY(0) translateX(0) rotate(0deg) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(var(--fall-distance)) translateX(var(--offset-x)) rotate(180deg) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(var(--fall-distance)) translateX(var(--offset-x)) rotate(360deg) scale(0.3);
            }
        }
        
        /* Bin card animation when item is added */
        .bin-card.new-item {
            animation: binPulse 0.6s ease-out;
        }
        
        @keyframes binPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(41, 50, 40, 0.1);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 16px rgba(41, 50, 40, 0.3);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(41, 50, 40, 0.1);
            }
        }
        
        .bin-fill.new-item {
            animation: fillBounce 0.8s ease-out;
        }
        
        @keyframes fillBounce {
            0% {
                transform: scaleY(0.8);
            }
            50% {
                transform: scaleY(1.05);
            }
            100% {
                transform: scaleY(1);
            }
        }
        
        /* Trash falling animation container */
        .trash-animation-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }
        
        .falling-trash {
            position: absolute;
            font-size: 24px;
            animation: fallIntoBin 1.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            pointer-events: none;
            z-index: 1001;
        }
        
        @keyframes fallIntoBin {
            0% {
                opacity: 1;
                transform: translateY(0) translateX(0) rotate(0deg) scale(1);
            }
            50% {
                opacity: 1;
                transform: translateY(var(--fall-distance)) translateX(var(--offset-x)) rotate(180deg) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(var(--fall-distance)) translateX(var(--offset-x)) rotate(360deg) scale(0.3);
            }
        }
        
        /* Bin card animation when item is added */
        .bin-card.new-item {
            animation: binPulse 0.6s ease-out;
        }
        
        @keyframes binPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(41, 50, 40, 0.1);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 16px rgba(41, 50, 40, 0.3);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 2px 8px rgba(41, 50, 40, 0.1);
            }
        }
        
        .bin-fill.new-item {
            animation: fillBounce 0.8s ease-out;
        }
        
        @keyframes fillBounce {
            0% {
                transform: scaleY(0.8);
            }
            50% {
                transform: scaleY(1.05);
            }
            100% {
                transform: scaleY(1);
            }
        }
    </style>
</head>
<body>
    <div class="app-container" data-location="{% if location %}{{ location }}{% else %}atlanta_ga_usa{% endif %}">
        <div class="app-header">
            <div class="school-name" id="schoolName">Testing Emory University Bin</div>
            <div class="app-title">Testing in Progress</div>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span class="live-text">LIVE</span>
            </div>
        </div>
        
        <div class="app-content">
            <!-- Insights Section -->
            <div class="insights-section">
                <div class="insights-title">ðŸ“Š Bin Insights</div>
                <div class="bins-grid" id="binsGrid">
                    <!-- Bins will be populated by JavaScript -->
                </div>
                <div class="stats-summary" id="statsSummary">
                    <div class="stat-row">
                        <span class="stat-label">Total Items Classified:</span>
                        <span class="stat-value" id="totalItems">0</span>
                    </div>
                </div>
            </div>
            
            <button class="btn-stop" onclick="stopAndReturn()">
                Stop
            </button>
        </div>
    </div>
    
    <!-- Trash falling animation container -->
    <div id="trashAnimationContainer" class="trash-animation-container"></div>
    
    <script>
        // School names mapping
        const schoolNames = {
            'atlanta_ga_usa': 'Testing Emory University Bin',
            'budapest_hungary': 'Testing Budapesti MÅ±szaki Egyetem',
            'hong_kong': 'Testing Hong Kong University',
            'singapore': 'Testing National University of Singapore'
        };
        
        // Get location from server or localStorage fallback
        const appContainer = document.querySelector('.app-container');
        const serverLocation = appContainer ? appContainer.getAttribute('data-location') : null;
        const currentLocation = serverLocation || localStorage.getItem('currentLocation') || 'atlanta_ga_usa';
        const schoolName = schoolNames[currentLocation] || 'Testing Emory University Bin';
        
        // Update school name on page load
        document.getElementById('schoolName').textContent = schoolName;
        
        async function stopAndReturn() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'Stopping system...';
            
            try {
                const response = await fetch('/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    window.location.href = '/';
                } else {
                    alert('Error stopping system: ' + (data.error || data.message || 'Unknown error'));
                    btn.disabled = false;
                    btn.textContent = 'Stop';
                }
            } catch (error) {
                alert('Network error: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Stop';
            }
        }
        
        // Insights polling
        let insightsInterval = null;
        let previousBinCounts = {}; // Track previous item counts for animation
        
        // Trash emojis by bin type
        const trashEmojis = {
            'recycling': ['ðŸ“„', 'ðŸ“°', 'ðŸ“¦', 'ðŸ¥¤', 'ðŸ¶', 'ðŸ“‹'],
            'compost': ['ðŸŒ', 'ðŸŽ', 'ðŸ¥¬', 'ðŸŒ¿', 'â˜•', 'ðŸ¥‘'],
            'landfill': ['ðŸ•', 'ðŸ”', 'ðŸ¥¤', 'ðŸ“±', 'ðŸ’¡', 'ðŸ—‘ï¸']
        };
        
        function getRandomTrashEmoji(binType) {
            const emojis = trashEmojis[binType] || ['ðŸ—‘ï¸'];
            return emojis[Math.floor(Math.random() * emojis.length)];
        }
        
        function createFallingTrashAnimation(binCard, binType) {
            const container = document.getElementById('trashAnimationContainer');
            if (!container) {
                console.error('Animation container not found');
                return;
            }
            
            // Get bin card position - wait a bit for DOM to settle
            setTimeout(() => {
                const binVisual = binCard.querySelector('.bin-visual');
                if (!binVisual) {
                    console.error('Bin visual element not found');
                    return;
                }
                
                const binVisualRect = binVisual.getBoundingClientRect();
                if (binVisualRect.width === 0 || binVisualRect.height === 0) {
                    console.error('Bin visual has zero dimensions');
                    return;
                }
                
                const targetX = binVisualRect.left + binVisualRect.width / 2;
                const targetY = binVisualRect.top + binVisualRect.height;
                
                // Create 2-3 trash items falling
                const trashCount = 2 + Math.floor(Math.random() * 2);
                const startY = binVisualRect.top - 150; // Start 150px above the bin
                
                console.log(`Creating ${trashCount} falling trash items for ${binType} bin at (${targetX}, ${targetY})`);
                
                for (let i = 0; i < trashCount; i++) {
                    const trash = document.createElement('div');
                    trash.className = 'falling-trash';
                    trash.textContent = getRandomTrashEmoji(binType);
                    
                    // Randomize starting position slightly above the bin
                    const startX = targetX + (Math.random() - 0.5) * 80;
                    const offsetX = (Math.random() - 0.5) * 30;
                    const fallDistance = targetY - startY; // Calculate fall distance in pixels
                    
                    trash.style.left = startX + 'px';
                    trash.style.top = startY + 'px';
                    trash.style.setProperty('--fall-distance', fallDistance + 'px');
                    trash.style.setProperty('--offset-x', offsetX + 'px');
                    
                    // Add slight delay for staggered effect
                    trash.style.animationDelay = (i * 0.1) + 's';
                    
                    container.appendChild(trash);
                    
                    // Remove after animation
                    setTimeout(() => {
                        if (trash.parentNode) {
                            trash.parentNode.removeChild(trash);
                        }
                    }, 1200 + (i * 100));
                }
            }, 50);
        }
        
        function updateInsights() {
            try {
                const location = currentLocation;
                const totalItemsEl = document.getElementById('totalItems');
                const binsGrid = document.getElementById('binsGrid');
                
                if (!totalItemsEl || !binsGrid) {
                    console.warn('Insights elements not found, skipping update');
                    return;
                }
                
                fetch(`/insights?location=${location}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.error) {
                            console.error('Insights error:', data.error);
                            return;
                        }
                        
                        // Debug logging
                        console.log('Insights data received:', data);
                        console.log('Bins count:', data.bins ? data.bins.length : 0);
                        
                        // Update total items
                        if (totalItemsEl) {
                            totalItemsEl.textContent = data.total_items || 0;
                        }
                        
                        // Update bins grid
                        if (binsGrid) {
                            binsGrid.innerHTML = '';
                            
                            if (data.bins && data.bins.length > 0) {
                                console.log('Processing bins:', data.bins);
                                data.bins.forEach(bin => {
                                    const binCard = document.createElement('div');
                                    binCard.className = 'bin-card';
                                    
                                    // Check if this bin has a new item
                                    const binKey = bin.type || bin.label;
                                    const previousCount = previousBinCounts[binKey] || 0;
                                    const currentCount = bin.item_count || 0;
                                    const hasNewItem = currentCount > previousCount;
                                    
                                    // Determine contamination status
                                    let contaminationClass = 'clean';
                                    let contaminationText = 'Clean';
                                    if (bin.contamination_percentage > 20) {
                                        contaminationClass = 'contaminated';
                                        contaminationText = `${bin.contamination_percentage}% contaminated`;
                                    } else if (bin.contamination_percentage > 0) {
                                        contaminationClass = 'warning';
                                        contaminationText = `${bin.contamination_percentage}% contaminated`;
                                    }
                                    
                                    const fillClass = hasNewItem ? `${bin.type} new-item` : bin.type;
                                    
                                    binCard.innerHTML = `
                                        <div class="bin-label">${bin.label || bin.type}</div>
                                        <div class="bin-visual">
                                            <div class="bin-fill ${fillClass}" style="height: ${bin.fill_percentage}%"></div>
                                        </div>
                                        <div class="bin-percentage">${bin.fill_percentage}%</div>
                                        <div class="bin-count">${bin.item_count} items</div>
                                        <div class="contamination-indicator ${contaminationClass}">
                                            ${contaminationText}
                                        </div>
                                    `;
                                    
                                    binsGrid.appendChild(binCard);
                                    
                                    // Trigger animation if new item detected (after DOM is ready)
                                    if (hasNewItem) {
                                        console.log(`New item detected in ${binKey}: ${previousCount} -> ${currentCount}`);
                                        // Use requestAnimationFrame to ensure DOM is ready
                                        requestAnimationFrame(() => {
                                            setTimeout(() => {
                                                try {
                                                    createFallingTrashAnimation(binCard, bin.type);
                                                    binCard.classList.add('new-item');
                                                    setTimeout(() => {
                                                        binCard.classList.remove('new-item');
                                                    }, 600);
                                                } catch (e) {
                                                    console.error('Animation error:', e);
                                                }
                                            }, 100);
                                        });
                                    }
                                    
                                    // Update previous count
                                    previousBinCounts[binKey] = currentCount;
                                });
                            } else {
                                binsGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: rgb(107, 125, 141); padding: 20px;">No bins configured yet</div>';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching insights:', error);
                        // Don't show error to user, just log it
                    });
            } catch (error) {
                console.error('Error in updateInsights:', error);
            }
        }
        
        // Start polling insights every 2 seconds (only after page is loaded)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                insightsInterval = setInterval(updateInsights, 2000);
                updateInsights(); // Initial load
            });
        } else {
            insightsInterval = setInterval(updateInsights, 2000);
            updateInsights(); // Initial load
        }
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (insightsInterval) {
                clearInterval(insightsInterval);
            }
        });
    </script>
</body>
</html>
